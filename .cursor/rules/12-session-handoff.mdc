---
globs: ["**/*"]
alwaysApply: true
---

# Session Health & Handoff

Monitor session health and **proactively alert** the user when a fresh chat would help.

## IMPORTANT: Automatic Health Checks

**After every response, internally check these conditions. If ANY ðŸ”´ condition is true, IMMEDIATELY show the Session Alert below.**

### ðŸ”´ Critical â€” Alert Immediately

| Condition | How to Detect |
|-----------|---------------|
| Same error 3+ times | You've attempted the same fix pattern 3 times without success |
| Undoing your own work | You're reverting changes you made earlier in this session |
| File/name confusion | You referred to wrong file name, confused two components, or forgot earlier context |
| Lost track of changes | You can't confidently list what files were modified this session |

### ðŸŸ¡ Warning â€” Mention at Natural Breakpoints

| Condition | How to Detect |
|-----------|---------------|
| Task completed | Original request is done, user is asking about something new |
| Scope expanded 3x+ | Task grew from "fix button" to "refactor entire component system" |
| 3+ unrelated tasks | Session covered authentication, then styling, then database, etc. |
| Same file edited 5+ times | You keep returning to edit the same file repeatedly |

## Session Alert Format

**When a ðŸ”´ condition is detected, show this alert:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš ï¸  SESSION HEALTH CHECK                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Signal detected: [what you noticed]                    â”‚
â”‚  Recommendation: Start a fresh chat                     â”‚
â”‚                                                         â”‚
â”‚  Say "generate handoff" to get a resume command,        â”‚
â”‚  or continue if you prefer.                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**For ðŸŸ¡ conditions, use a softer mention:**

> "We've completed [task]. This is a good checkpoint â€” let me know if you'd like a handoff to continue in a fresh chat, or we can keep going."

## Self-Assessment Checklist

Before responding to complex requests, quickly self-check:

- [ ] Do I remember what files I've modified this session?
- [ ] Am I confident about the current state of the code?
- [ ] Is this the same task we started with, or has it evolved?
- [ ] Have I been going in circles on any issue?

If you answer "no" or "unsure" to any of these, surface it to the user.

## Handoff Command Format

When suggesting a new chat, generate this handoff block:

```markdown
---
## ðŸ”„ Session Handoff

### Completed
- [x] What was accomplished
- [x] Key decisions made

### In Progress  
- [ ] Current task state
- [ ] What's partially done

### Files Modified
- `path/to/file.ts` - what changed
- `path/to/other.ts` - what changed

### Next Steps
1. Immediate next action
2. Following action

### Context
- Key decision: [why we chose X over Y]
- Blocked by: [any blockers]
- Note: [anything the next session needs to know]

### Resume Command
```
Continue working on [feature/task]. 

We already:
- [completed item 1]
- [completed item 2]

Next: [specific next action]

Key files: `file1.ts`, `file2.ts`
```
---
```

## Automatic Handoff Triggers

**Generate handoff automatically when user says:**
- "Let's continue this in a new chat"
- "I'm going to start fresh"
- "Generate a handoff"
- "Summarize for next session"
- "Create a checkpoint"

**Also offer handoff when:**
- Completing a major feature/milestone
- Before switching to unrelated work
- When you detect context confusion

## Handoff Best Practices

### Include
- Specific file paths modified
- Concrete next steps (not vague)
- Key decisions and WHY
- Any gotchas or warnings

### Don't Include
- Full code dumps (they're in git)
- Speculation about future work
- Resolved issues
- Internal thought process

## Quick Handoff Template

For rapid handoffs when time is short:

```markdown
**Quick Handoff**: Working on [task]. Done: [1-2 items]. Next: [specific action]. Key files: `file.ts`. Note: [one critical context].
```

## Session Metrics to Track

Mentally track these during the session:

| Metric | Healthy | Concerning |
|--------|---------|------------|
| Edit success rate | 80%+ edits work first try | 50%+ need revision |
| Task focus | 1-2 related tasks | 4+ unrelated tasks |
| File churn | Files edited once | Same file edited 5+ times |
| User corrections | Occasional | Frequent "no, I meant..." |

## Integration with Todos

If using TodoWrite, include todo state in handoff:

```markdown
### Todo State
- [x] completed-task-id: Description
- [ ] pending-task-id: Description  
- [~] in-progress-task-id: Description (partial: what's done)
```

## Example Full Handoff

```markdown
---
## ðŸ”„ Session Handoff

### Completed
- [x] Set up authentication with NextAuth.js
- [x] Created login/signup pages
- [x] Added protected route middleware

### In Progress  
- [ ] User profile page (component created, needs API integration)

### Files Modified
- `src/app/api/auth/[...nextauth]/route.ts` - Auth config
- `src/app/(auth)/login/page.tsx` - Login form
- `src/app/(auth)/signup/page.tsx` - Signup form
- `src/middleware.ts` - Route protection
- `src/components/user-profile.tsx` - Started, incomplete

### Next Steps
1. Create `/api/user/profile` endpoint
2. Connect UserProfile component to API
3. Add profile edit functionality

### Context
- Using Credentials provider (not OAuth) per user preference
- Session strategy is JWT, not database
- Profile component needs `useSession` hook integration

### Resume Command
```
Continue the auth implementation. 

Done: NextAuth setup, login/signup pages, middleware.
Next: Create the profile API endpoint at `/api/user/profile` 
and connect it to the UserProfile component.

Key files: `src/components/user-profile.tsx`, `src/app/api/`
```
---
```
